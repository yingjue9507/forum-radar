name: Build Android APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # 允许手动点击按钮触发

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. 拉取代码
    - uses: actions/checkout@v4

    # 2. 设置 Python 3.11
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    # 3. 设置 Java 17 (安卓打包必须)
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # 4. 设置 Flutter 环境 (使用最新版)
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: "3.24.x"
        channel: "stable"

    # 5. 安装依赖 (从 requirements.txt 读取)
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # 6. 开始打包 (关键步骤！)
    # yes | 是为了自动回答 "y"，防止卡住
    # **/*.apk 是为了不管文件生成在哪都能找到
    - name: Build APK
      run: |
        yes | flet build apk --verbose

    # 7. 上传结果
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: ForumRadar_APK
        path: "**/*.apk"
